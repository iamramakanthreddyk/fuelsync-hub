# DATABASE\_GUIDE.md â€” FuelSync Hub

This guide documents the database schema, relationships, and key queries used in the FuelSync ERP system.

---

## ðŸ“Š Entity Relationship Overview

```mermaid
erDiagram
    ADMIN_USERS ||--o{ ADMIN_ACTIVITY_LOGS : logs
    USERS ||--o{ USER_STATIONS : "assigned_to"
    STATIONS ||--o{ USER_STATIONS : "has_users"
    STATIONS ||--o{ PUMPS : "has"
    PUMPS ||--o{ NOZZLES : "contains"
    NOZZLES ||--o{ NOZZLE_READINGS : "recorded_by"
    NOZZLES ||--o{ SALES : "generates"
    STATIONS ||--o{ FUEL_PRICES : "defines"
    STATIONS ||--o{ CREDITORS : "manages"
    CREDITORS ||--o{ CREDIT_PAYMENTS : "makes"
    STATIONS ||--o{ FUEL_DELIVERIES : "receives"
    STATIONS ||--o{ DAY_RECONCILIATIONS : "records"
```

---

## ðŸ”„ Core Tables by Domain

### User Access

* `admin_users` âž” Superadmin login/auth
* `users` âž” Tenant users (owner, manager, attendant)
* `user_stations` âž” Links users to stations + roles

### Tenant Scope

* `tenants` âž” Each tenant has a schema
* `plans`, `plan_features` âž” Plan enforcement
* `tenant_settings` âž” Branding, currency, theme

### Station Management

* `stations` âž” Fuel station info
* `pumps`, `nozzles` âž” Nested hardware hierarchy

### Operational Data

* `nozzle_readings` âž” Manual readings
* `sales` âž” Generated by delta readings
* `fuel_prices` âž” Price per fuel type
* `fuel_deliveries` âž” Restock records
* `fuel_inventory` âž” Tank levels
* `day_reconciliations` âž” Daily sales summary

### Credit & Payments

* `creditors` âž” Named credit parties
* `credit_payments` âž” Payment against credits

### Activity Logs

* `admin_activity_logs`
* `activity_logs`
* `user_sessions`

---

## ðŸª¡ Sample Business Queries

### 1. All Sales for a Station (last 7 days)

```sql
SELECT * FROM sales
WHERE station_id = $1
  AND recorded_at >= NOW() - INTERVAL '7 days';
```

### 2. Nozzle Reading Gaps / Invalids

```sql
SELECT * FROM nozzle_readings nr
JOIN nozzles n ON nr.nozzle_id = n.id
WHERE nr.reading < n.initial_reading;
```

### 3. Total Outstanding Credit

```sql
SELECT SUM(running_balance) FROM creditors
WHERE active = TRUE;
```

### 4. Daily Summary (Reconciliation)

```sql
SELECT date, total_sales, cash_total, credit_total
FROM day_reconciliations
WHERE station_id = $1
ORDER BY date DESC LIMIT 7;
```

### 5. Top Creditors by Balance

```sql
SELECT party_name, running_balance
FROM creditors
ORDER BY running_balance DESC
LIMIT 5;
```

---

## ðŸ“Š Notes

* All monetary values are in **INR (â‚¹)**
* Reading-based sales use cumulative model:

  ```ts
  sale_volume = new_reading - previous_reading
  amount = sale_volume * fuel_price
  ```
* Data integrity enforced via triggers + foreign keys
* Multi-tenancy achieved via schema-per-tenant model

---

> Next: See `TROUBLESHOOTING.md` for known issues & debugging guidance.
